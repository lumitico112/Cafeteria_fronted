<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-cart-plus me-2 text-secondary"></i>Nuevo Pedido</h2>
    <a routerLink="/pedidos" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Volver
    </a>
  </div>

  <div class="row" *ngIf="!isLoading; else loadingTemplate">
    <!-- Formulario de Pedido -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 fw-bold">Detalle del Pedido</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="pedidoForm">
            <!-- Selección de Tipo de Entrega -->
            <div class="mb-4">
              <label class="form-label fw-bold">Tipo de Entrega</label>
              <div class="d-flex gap-3">
                <div class="form-check card-radio">
                  <input class="form-check-input" type="radio" formControlName="tipoEntrega" value="LOCAL" id="entregaLocal">
                  <label class="form-check-label" for="entregaLocal">
                    <i class="fas fa-store me-2"></i>Consumo en Local
                  </label>
                </div>
                <div class="form-check card-radio">
                  <input class="form-check-input" type="radio" formControlName="tipoEntrega" value="RETIRO" id="entregaRetiro">
                  <label class="form-check-label" for="entregaRetiro">
                    <i class="fas fa-walking me-2"></i>Para Llevar (Retiro)
                  </label>
                </div>
                <div class="form-check card-radio">
                  <input class="form-check-input" type="radio" formControlName="tipoEntrega" value="DELIVERY" id="entregaDelivery">
                  <label class="form-check-label" for="entregaDelivery">
                    <i class="fas fa-motorcycle me-2"></i>Delivery
                  </label>
                </div>
              </div>
            </div>

            <!-- Lista de Productos -->
            <h5 class="fw-bold mb-3">Productos</h5>
            <div formArrayName="detalles">
              <div *ngFor="let detalle of detalles.controls; let i = index" [formGroupName]="i" class="card mb-3 border-light bg-light">
                <div class="card-body p-3">
                  <div class="row align-items-center g-3">
                    <div class="col-md-6">
                      <label class="form-label small text-muted mb-1">Producto</label>
                      <select class="form-select" formControlName="idProducto" (change)="onProductoChange(i)">
                        <option value="" disabled>Seleccione un producto</option>
                        <option *ngFor="let prod of productos" [value]="prod.idProducto">
                          {{ prod.nombre }} - S/ {{ prod.precio | number:'1.2-2' }}
                        </option>
                      </select>
                    </div>
                    <div class="col-md-3 col-6">
                      <label class="form-label small text-muted mb-1">Cantidad</label>
                      <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" (click)="updateCantidad(i, -1)">-</button>
                        <input type="number" class="form-control text-center" formControlName="cantidad" min="1" readonly>
                        <button class="btn btn-outline-secondary" type="button" (click)="updateCantidad(i, 1)">+</button>
                      </div>
                    </div>
                    <div class="col-md-2 col-6 text-end">
                      <label class="form-label small text-muted mb-1 d-block">Subtotal</label>
                      <span class="fw-bold text-primary">S/ {{ getSubtotal(i) | number:'1.2-2' }}</span>
                    </div>
                    <div class="col-md-1 text-end">
                      <button type="button" class="btn btn-outline-danger btn-sm mt-3" (click)="removeDetalle(i)" *ngIf="detalles.length > 1">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <button type="button" class="btn btn-outline-primary w-100 mt-2" (click)="addDetalle()">
              <i class="fas fa-plus me-2"></i>Agregar Producto
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Resumen -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 sticky-top" style="top: 80px; z-index: 10;">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 fw-bold">Resumen</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Subtotal</span>
            <span>S/ {{ total | number:'1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between mb-3">
            <span class="text-muted">Impuestos (IGV)</span>
            <span>S/ {{ total * 0.18 | number:'1.2-2' }}</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center mb-4">
            <span class="fs-5 fw-bold">Total a Pagar</span>
            <span class="fs-4 fw-bold text-primary">S/ {{ total * 1.18 | number:'1.2-2' }}</span>
          </div>

          <div class="d-grid">
            <button class="btn btn-primary btn-lg" (click)="onSubmit()" [disabled]="pedidoForm.invalid || isSaving || total === 0">
              <i class="fas fa-check-circle me-2"></i>
              {{ isSaving ? 'Procesando...' : 'Confirmar Pedido' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3 text-muted">Cargando catálogo de productos...</p>
    </div>
  </ng-template>
</div>
