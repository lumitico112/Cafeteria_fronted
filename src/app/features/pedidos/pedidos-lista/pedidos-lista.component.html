<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-receipt me-2 text-secondary"></i>Gestión de Pedidos</h2>
  <button class="btn btn-outline-primary" (click)="loadPedidos()">
    <i class="fas fa-sync-alt me-2"></i>Actualizar
  </button>
</div>

<!-- Filtros de Estado -->
<div class="card mb-4 border-0 shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-sm rounded-pill" 
              [class.btn-primary]="selectedEstado === ''"
              [class.btn-outline-secondary]="selectedEstado !== ''"
              (click)="filterByEstado('')">
        Todos
      </button>
      <button class="btn btn-sm rounded-pill" 
              [class.btn-warning]="selectedEstado === 'PENDIENTE'"
              [class.btn-outline-warning]="selectedEstado !== 'PENDIENTE'"
              (click)="filterByEstado('PENDIENTE')">
        Pendientes
      </button>
      <button class="btn btn-sm rounded-pill" 
              [class.btn-info]="selectedEstado === 'PREPARACION'"
              [class.btn-outline-info]="selectedEstado !== 'PREPARACION'"
              (click)="filterByEstado('PREPARACION')">
        En Preparación
      </button>
      <button class="btn btn-sm rounded-pill" 
              [class.btn-primary]="selectedEstado === 'LISTO'"
              [class.btn-outline-primary]="selectedEstado !== 'LISTO'"
              (click)="filterByEstado('LISTO')">
        Listos
      </button>
      <button class="btn btn-sm rounded-pill" 
              [class.btn-info]="selectedEstado === 'EN_CAMINO'"
              [class.btn-outline-info]="selectedEstado !== 'EN_CAMINO'"
              (click)="filterByEstado('EN_CAMINO')">
        En Camino
      </button>
      <button class="btn btn-sm rounded-pill" 
              [class.btn-success]="selectedEstado === 'ENTREGADO'"
              [class.btn-outline-success]="selectedEstado !== 'ENTREGADO'"
              (click)="filterByEstado('ENTREGADO')">
        Entregados
      </button>
    </div>
  </div>
</div>

<!-- Grid de Pedidos -->
<div class="row g-4">
  <div class="col-md-6 col-lg-4" *ngFor="let pedido of filteredPedidos">
    <div class="card h-100 border-start-4 shadow-sm" 
         [ngClass]="{
           'border-warning': pedido.estado === 'PENDIENTE',
           'border-info': pedido.estado === 'PREPARACION' || pedido.estado === 'EN_CAMINO',
           'border-primary': pedido.estado === 'LISTO',
           'border-success': pedido.estado === 'ENTREGADO',
           'border-danger': pedido.estado === 'CANCELADO'
         }">
      <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <span class="fw-bold">Pedido #{{ pedido.idPedido }}</span>
        <span class="badge" 
              [ngClass]="{
                'bg-warning text-dark': pedido.estado === 'PENDIENTE',
                'bg-info text-white': pedido.estado === 'PREPARACION',
                'bg-primary': pedido.estado === 'LISTO',
                'bg-info text-dark': pedido.estado === 'EN_CAMINO',
                'bg-success': pedido.estado === 'ENTREGADO',
                'bg-danger': pedido.estado === 'CANCELADO'
              }">
          {{ pedido.estado }}
        </span>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <small class="text-muted d-block mb-1">Cliente</small>
          <h6 class="mb-0"><i class="fas fa-user me-2 text-secondary"></i>{{ pedido.nombreCliente || 'Cliente' }}</h6>
        </div>
        
        <div class="row mb-3">
          <div class="col-6">
            <small class="text-muted d-block mb-1">Fecha</small>
            <span>{{ pedido.fecha | date:'short' }}</span>
          </div>
          <div class="col-6">
            <small class="text-muted d-block mb-1">Tipo</small>
            <span>{{ pedido.tipoEntrega }}</span>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
          <span class="text-muted">{{ pedido.detalles?.length || 0 }} items</span>
          <h5 class="mb-0 text-primary fw-bold">S/ {{ pedido.total | number:'1.2-2' }}</h5>
        </div>
      </div>
      <div class="card-footer bg-white py-3">
        <div class="d-grid gap-2">
          <a [routerLink]="['/pedidos/detalle', pedido.idPedido]" class="btn btn-outline-primary btn-sm">
            Ver Detalle
          </a>
          
          <div class="d-flex gap-2" *ngIf="pedido.estado !== 'ENTREGADO' && pedido.estado !== 'CANCELADO'">
            
            <!-- Botones de Acción Principal -->
            <button *ngIf="pedido.estado === 'PENDIENTE'" 
                    class="btn btn-sm btn-info text-white" 
                    (click)="updateEstado(pedido, 'PREPARACION')"
                    title="Iniciar Preparación">
              <i class="fas fa-fire"></i> Preparar
            </button>

            <button *ngIf="pedido.estado === 'PREPARACION'" 
                    class="btn btn-sm btn-primary" 
                    (click)="updateEstado(pedido, 'LISTO')"
                    title="Marcar como Listo">
              <i class="fas fa-check"></i> Listo
            </button>

            <!-- Flujo Delivery -->
            <button *ngIf="pedido.estado === 'LISTO' && pedido.tipoEntrega === 'DELIVERY'" 
                    class="btn btn-sm btn-info text-white" 
                    (click)="updateEstado(pedido, 'EN_CAMINO')"
                    title="Enviar Pedido">
              <i class="fas fa-motorcycle"></i> Enviar
            </button>

            <!-- Flujo Tienda/Retiro -->
            <button *ngIf="pedido.estado === 'LISTO' && pedido.tipoEntrega !== 'DELIVERY'" 
                    class="btn btn-sm btn-success" 
                    (click)="updateEstado(pedido, 'ENTREGADO')"
                    title="Entregar Pedido">
              <i class="fas fa-box"></i> Entregar
            </button>

            <button *ngIf="pedido.estado === 'EN_CAMINO' && isAdmin" 
                    class="btn btn-sm btn-success" 
                    (click)="updateEstado(pedido, 'ENTREGADO')"
                    title="Confirmar Entrega">
              <i class="fas fa-check-double"></i> Confirmar
            </button>

            <!-- Botón Cancelar -->
            <button class="btn btn-sm btn-outline-danger" 
                    (click)="updateEstado(pedido, 'CANCELADO')"
                    title="Cancelar Pedido">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!isLoading && filteredPedidos.length === 0" class="alert alert-info text-center mt-4">
  No hay pedidos con el estado seleccionado.
</div>
